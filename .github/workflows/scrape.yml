name: JKK Scraper

on:
#  schedule:
#    # UTC23ã€œUTC23:55 â†’ JST8ã€œ8:55
#    - cron: '*/5 23 * * *'
#    # UTC0ã€œUTC12:55 â†’ JST9ã€œ21:55
#    - cron: '*/5 0-15 * * *'
  workflow_dispatch:  # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½

jobs:
  scrape:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
      
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    # âœ… Chrome & ChromeDriver ã‚’è‡ªå‹•ã§åŒæœŸã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
    - name: Install matching ChromeDriver
      run: |
        sudo apt update
        sudo apt install -y google-chrome-stable unzip curl
        CHROME_VERSION=$(google-chrome --version | grep -oE '[0-9]+(\.[0-9]+){3}' | cut -d '.' -f 1)
        echo "Detected Chrome major version: $CHROME_VERSION"
        DRIVER_VERSION=$(curl -s "https://googlechromelabs.github.io/chrome-for-testing/known-good-versions-with-downloads.json" \
          | jq -r --arg v "$CHROME_VERSION" '.versions[] | select(.version | startswith($v + ".")) | .version' | head -n 1)
        echo "Installing ChromeDriver version: $DRIVER_VERSION"
        DRIVER_URL=$(curl -s "https://googlechromelabs.github.io/chrome-for-testing/known-good-versions-with-downloads.json" \
          | jq -r --arg v "$DRIVER_VERSION" '.versions[] | select(.version == $v) | .downloads.chromedriver[] | select(.platform=="linux64").url')
        curl -Lo chromedriver.zip "$DRIVER_URL"
        unzip chromedriver.zip
        sudo mv chromedriver-linux64/chromedriver /usr/local/bin/
        sudo chmod +x /usr/local/bin/chromedriver
 
      
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install selenium beautifulsoup4 requests jq

    - name: Set Discord Webhook
      run: echo "DISCORD_WEBHOOK_URL=${{ secrets.DISCORD_WEBHOOK_URL }}" >> $GITHUB_ENV

      # --- ã‚­ãƒ£ãƒƒã‚·ãƒ¥å¾©å…ƒ ---
    - name: Restore previous result cache
      uses: actions/cache@v4
      with:
        path: previous_result.txt
        key: previous-result-${{ github.run_id }}
        restore-keys: |
          previous-result-
        
    - name: Show cached previous result
      if: steps.cache-prev.outputs.cache-hit == 'true'
      run: |
        echo "ğŸ“‚ Cached previous_result.txt contents:"
        cat previous_result.txt || echo "âš ï¸ previous_result.txt not found"

        
    - name: Run scraper
      run: python main_scrape4.py
      
# --- ã‚­ãƒ£ãƒƒã‚·ãƒ¥ä¿å­˜ï¼ˆå¸¸ã«æœ€æ–°ã«æ›´æ–°ï¼‰---
    - name: Save previous result cache
      uses: actions/cache@v4
      with:
        path: previous_result.txt
        key: previous-result-${{ github.run_id }}

    
    
